// Generated by CoffeeScript 1.6.1
"use strict";
var clients, createRoom, doUserName, htmlEntities, http, joinRoom, listRooms, rooms, server, userNames, webSocketServer, webSocketsServerPort, wsServer;

webSocketsServerPort = 8088;

webSocketServer = require('websocket').server;

http = require('http');

/*
 * Global variables
*/


clients = [];

userNames = {};

userNames['nono'] = true;

rooms = ['lounge', 'entrance'];

/*
 * Helper function for escaping input strings
*/


htmlEntities = function(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
};

createRoom = function(connection, name) {
  rooms.push(name);
  return listRooms(connection);
};

listRooms = function(connection) {
  return connection.sendUTF(JSON.stringify({
    type: 'roomList',
    data: rooms
  }));
};

joinRoom = function(userName, room, index) {
  var clnt;
  console.log(userName || 'listener' + ' should join ' + room);
  clnt = clients[index];
  clnt.inRoom = room;
  return room;
};

doUserName = function(connection, message) {
  var userName;
  userName = htmlEntities(message);
  console.log((new Date()) + ' Checking: ' + userName);
  if (userNames[userName]) {
    connection.sendUTF(JSON.stringify({
      type: 'refuseNickname',
      data: userName
    }));
    console.log((new Date()) + ' User refused (existing): ' + userName);
    return false;
  }
  userNames[userName] = true;
  connection.sendUTF(JSON.stringify({
    type: 'acceptNickname',
    data: userName
  }));
  console.log((new Date()) + ' User is known as: ' + userName);
  return userName;
};

/*
 * HTTP server
*/


server = http.createServer(function(request, response) {});

server.listen(webSocketsServerPort, function() {
  return console.log((new Date()) + " Server is listening on port " + webSocketsServerPort);
});

/*
 * WebSocket server
*/


wsServer = new webSocketServer({
  httpServer: server
});

wsServer.on('request', function(request) {
  var con, connection, inRoom, index, userName;
  console.log((new Date()) + ' Connection from origin ' + request.origin + '.');
  /*
  # accept connection - you should check 'request.origin' to make sure that
  # client is connecting from your website
  # (http://en.wikipedia.org/wiki/Same_origin_policy)
  */

  connection = request.accept(null, request.origin);
  con = {
    connection: connection,
    room: ''
  };
  index = clients.push(con) - 1;
  userName = false;
  inRoom = false;
  console.log((new Date()) + ' Connection accepted.');
  connection.on('message', function(messageObj) {
    var chat, client, e, json, message, obj, _fn, _i, _len;
    if (messageObj.type !== 'utf8') {
      console.log('Rejecting funny stuff');
      return;
    }
    try {
      message = JSON.parse(messageObj.utf8Data);
    } catch (_error) {
      e = _error;
      console.log('This doesn\'t look like a valid JSON: ', messageObj.utf8Data);
    }
    console.log((new Date()) + ' Received Message type: ' + message.type + ' data: ' + message.data);
    if (message.type === 'listRooms') {
      listRooms(connection);
      return;
    }
    if (message.type === 'join') {
      inRoom = joinRoom(userName, message.data, index);
      return;
    }
    if (message.type === 'room') {
      createRoom(connection, message.data);
      return;
    }
    if (message.type === 'handle') {
      userName = doUserName(connection, message.data);
      console.log((new Date()) + ' Recognize user: ' + userName);
      return;
    }
    chat = message.data;
    console.log((new Date()) + ' Received Message from ' + userName + ': ' + chat);
    obj = {
      time: (new Date()).getTime(),
      text: htmlEntities(chat),
      author: userName,
      room: inRoom
    };
    if (!userName) {
      obj.text = "Please choose a valid nick to be able to chat";
      obj.author = '(system says)';
      connection.sendUTF(JSON.stringify({
        type: 'message',
        data: obj
      }));
      return;
    }
    json = JSON.stringify({
      type: 'message',
      data: obj
    });
    _fn = function(client, inRoom) {
      console.log((new Date()) + " Im in room '" + inRoom + "' client is in: " + client.inRoom);
      console.log("Sending" + obj.text);
      if (client.inRoom === inRoom) {
        return client.connection.sendUTF(json);
      }
    };
    for (_i = 0, _len = clients.length; _i < _len; _i++) {
      client = clients[_i];
      _fn(client, inRoom);
    }
  });
  return connection.on('close', function(connection) {
    if (userName === false) {
      return;
    }
    console.log((new Date()) + " Peer " + connection.remoteAddress + " disconnected.");
    clients.splice(index, 1);
  });
});
